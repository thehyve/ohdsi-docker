version: '3.5'

services:
  traefik:
    image: traefik:2.4
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=api"
      - "--entrypoints.web.address=:80"
    networks:
      - api
      - public
    volumes:
      - "./etc/letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    ports:
      - 80:80

  atlas:
    image: ${ATLAS_IMAGE}
    networks:
      - api
    environment:
      WEBAPI_URL: ${BASE_URL}/WebAPI/
      ATLAS_HOSTNAME: ${HOSTNAME}
    volumes:
      - "./etc/atlas/config-local.js:/etc/atlas/config-local.js"
      - "./lib/atlas/atlas-replace-config-local.sh:/docker-entrypoint.d/25-atlas-replace-config-local.sh"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.atlas.rule=Host(`${HOSTNAME}`) && PathPrefix(`/atlas`)"
      - "traefik.http.services.atlas.loadbalancer.server.port=8080"

  webapi:
    image: ${WEBAPI_IMAGE}
    volumes:
     - ./lib/webapi/drivers:/var/lib/ohdsi/webapi/drivers:ro
    networks:
      - api
      - ohdsi-postgresql
    depends_on:
      - postgresql
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.webapi.rule=Host(`${HOSTNAME}`) && PathPrefix(`/WebAPI`)"
      - "traefik.http.routers.webapi.entrypoints=web"
      - "traefik.http.services.webapi.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.cors.headers.accesscontrolexposeheaders=Bearer,x-auth-error,x-auth-provider,x-requested-with,x-requested-by"
      - "traefik.http.middlewares.cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT"
      - "traefik.http.middlewares.cors.headers.accesscontrolalloworigin=*"
      - "traefik.http.middlewares.cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.cors.headers.addvaryheader=true"
      - "traefik.http.routers.webapi.middlewares=cors@docker"

    environment:
      - JAVA_OPTS=-Xmx4g
      - CLASSPATH=":/var/lib/ohdsi/webapi/drivers/*"
      - WEBAPI_URL=${BASE_URL}
      - env=webapi-postgresql
      - datasource_driverClassName=org.postgresql.Driver
      - datasource_url=jdbc:postgresql://postgresql:5432/ohdsi
      - datasource_cdm_schema=cdm
      - datasource_ohdsi_schema=ohdsi
      - datasource_username=postgres
      - datasource_password=${POSTGRESQL_PASSWORD}
      - spring_jpa_properties_hibernate_default__schema=ohdsi
      - spring_jpa_properties_hibernate_dialect=org.hibernate.dialect.PostgreSQLDialect
      - spring_batch_repository_tableprefix=ohdsi.BATCH_
      - flyway_datasource_driverClassName=org.postgresql.Driver
      - flyway_datasource_url=jdbc:postgresql://postgresql:5432/ohdsi
      - flyway_schemas=ohdsi
      - flyway_placeholders_ohdsiSchema=ohdsi
      - flyway_datasource_username=postgres
      - flyway_datasource_password=${POSTGRESQL_PASSWORD}
      - flyway_locations=classpath:db/migration/postgresql
      - security_cors_enabled=false
      - security_provider=AtlasRegularSecurity
      - security_origin="*"
      - security_oid_authMethod=client_secret_basic
      - security_oid_clientId=webapi
      - security_oid_apiSecret=${WEBAPI_CLIENT_SECRET}
      - security_oid_url=http://keycloak:8080/auth/realms/ohdsi-docker/.well-known/openid-configuration
      - security_oid_redirectUrl=http://${HOSTNAME}/atlas/index.html
      - security_oauth_callback_api=http://${HOSTNAME}/WebAPI/user/oauth/callback

  postgresql:
    image: bitnami/postgresql:13
    shm_size: 256m
    networks:
      - ohdsi-postgresql
      - jupyter-notebook
    volumes:
      - postgresql_data:/bitnami/postgresql
      - ./etc/postgresql/initdb.d:/docker-entrypoint-initdb.d:ro
      - ./data/vocabulary:/data/vocabulary
    environment:
      - POSTGRESQL_USERNAME=postgres
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - PGPASSWORD=${POSTGRESQL_PASSWORD}
      - POSTGRESQL_DATABASE=ohdsi
    restart: unless-stopped

  keycloak-postgresql:
    image: bitnami/postgresql:13
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_POSTGRESQL_PASSWORD}
    volumes:
      - keycloak_data:/bitnami/postgresql
    networks:
      - keycloak-postgresql
    restart: unless-stopped

  keycloak:
    image: jboss/keycloak:12.0.2
    restart: unless-stopped
    environment:
      DB_VENDOR: POSTGRES
      DB_ADDR: keycloak-postgresql
      DB_DATABASE: keycloak
      DB_USER: keycloak
      DB_PASSWORD: ${KEYCLOAK_POSTGRESQL_PASSWORD}
      KEYCLOAK_USER: 'admin'
      KEYCLOAK_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KEYCLOAK_HOSTNAME: ${HOSTNAME}
      KEYCLOAK_HTTP_PORT: 80
      PROXY_ADDRESS_FORWARDING: 'true'
    networks:
      - api
      - keycloak-postgresql
    depends_on:
      - keycloak-postgresql
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak.rule=Host(`${HOSTNAME}`) && PathPrefix(`/auth`)"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"

  jupyterhub:
    restart: unless-stopped
    build:
      context: images/jupyterhub
      args:
        JUPYTERHUB_VERSION: "1.4.1"
    depends_on:
      - jupyterhub-postgresql
    image: thehyve/ohdsi-jupyterhub:1.4.1
    volumes:
      # Bind Docker socket on the host so we can connect to the daemon from
      # within the container
      - "/var/run/docker.sock:/var/run/docker.sock:rw"
      # Bind Docker volume on host for JupyterHub database and cookie secrets
      - "jupyterhub_data:/data"
    environment:
      DATA_VOLUME_CONTAINER: '/data'
      DOCKER_SPAWN_CMD: 'start-singleuser.sh --SingleUserNotebookApp.default_url=/lab'
      OAUTH2_TOKEN_URL: 'http://${HOSTNAME}/auth/realms/ohdsi-docker/protocol/openid-connect/token'
      OAUTH2_AUTHORIZE_URL: 'http://${HOSTNAME}/auth/realms/ohdsi-docker/protocol/openid-connect/auth'
      OAUTH2_USERNAME_KEY: 'preferred_username'
      OAUTH_CLIENT_SECRET: '${JUPYTER_CLIENT_SECRET}'
      OAUTH_CALLBACK_URL: 'http://console.${HOSTNAME}/hub/oauth_callback'
      OAUTH2_USERDATA_URL: 'http://${HOSTNAME}/auth/realms/ohdsi-docker/protocol/openid-connect/userinfo'
      OAUTH_CLIENT_ID: jupyterhub
      #DOCKER_NOTEBOOK_IMAGE: 'jupyter/datascience-notebook'
      DOCKER_NOTEBOOK_IMAGE: 'thehyve/ohdsi-jupyter-notebook'
      DOCKER_NETWORK_NAME: "${COMPOSE_PROJECT_NAME}_jupyter-notebook"
      DOCKER_NOTEBOOK_DIR: '/home/jovyan'
      DATA_VOLUME_CONTAINER: '/data/'
      POSTGRES_HOST: 'jupyterhub-postgresql'
      POSTGRES_DB: jupyterhub
      POSTGRES_USER: jupyterhub
      POSTGRES_PASSWORD: ${JUPYTERHUB_POSTGRESQL_PASSWORD}
    networks:
      - api
      - jupyterhub-postgresql
      - jupyter-notebook
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jupyter.rule=Host(`console.${HOSTNAME}`)"
      - "traefik.http.services.jupyter.loadbalancer.server.port=8000"

  jupyterhub-postgresql:
    image: bitnami/postgresql:13
    environment:
      POSTGRES_DB: jupyterhub
      POSTGRES_USER: jupyterhub
      POSTGRES_PASSWORD: ${JUPYTERHUB_POSTGRESQL_PASSWORD}
    volumes:
      - jupyterhub_data:/bitnami/postgresql
    networks:
      - jupyterhub-postgresql
    restart: unless-stopped

volumes:
  postgresql_data:
    driver: local
  keycloak_data:
    driver: local
  jupyterhub_data:
    driver: local
#  jh_shared:
#    driver: local

networks:
  public:
    driver: bridge
    internal: false
  api:
    name: api
    driver: bridge
    internal: true
  keycloak-postgresql:
    driver: bridge
    internal: true
  jupyterhub-postgresql:
    driver: bridge
    internal: true
  ohdsi-postgresql:
    driver: bridge
    internal: true
  jupyter-notebook:
    driver: bridge
    internal: false
